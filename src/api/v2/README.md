# DeepSearchAgents Web API v2

A modern, event-driven API for real-time interaction with DeepSearchAgents through WebSocket and REST endpoints. This API provides granular visibility into agent reasoning, code generation, execution, and tool usage.

## Overview

The Web API v2 is designed to power rich, interactive web UIs that show users the complete agent execution process. It features:

- **Real-time streaming** via WebSocket and Server-Sent Events
- **Granular event types** for every step of agent execution
- **Session management** for multi-turn conversations
- **Type-safe client libraries** with TypeScript definitions
- **Clean separation** between reasoning, code, and execution

## Architecture

```
┌─────────────┐     WebSocket/SSE      ┌──────────────┐
│   Web UI    │ ◄───────────────────► │  API v2      │
│  (React)    │                        │  Endpoints   │
└─────────────┘                        └──────┬───────┘
                                              │
                                              ▼
                                        ┌──────────────┐
                                        │   Session    │
                                        │  Manager     │
                                        └──────┬───────┘
                                              │
                                              ▼
                                        ┌──────────────┐
                                        │    Event     │
                                        │  Processor   │
                                        └──────┬───────┘
                                              │
                                              ▼
                                        ┌──────────────┐
                                        │  WebUI       │
                                        │  Adapter     │
                                        └──────┬───────┘
                                              │
                                              ▼
                                        ┌──────────────┐
                                        │    Agent     │
                                        │(React/CodeAct)│
                                        └──────────────┘
```

## Quick Start

### 1. Start the API Server

```bash
# With Web API v2 enabled (default)
python -m src.main --port 8000

# The v2 endpoints will be available at:
# - WebSocket: ws://localhost:8000/api/v2/ws/agent/{session_id}
# - REST: http://localhost:8000/api/v2/*
```

### 2. Connect via WebSocket (JavaScript/TypeScript)

```typescript
import { createAgentClient, EventType } from './api/v2/types/agent-client';

// Create and connect client
const client = await createAgentClient('my-session-123');

// Register event handlers
client.on(EventType.AGENT_THOUGHT, (event) => {
  console.log('Agent thinking:', event.content);
});

client.on(EventType.CODE_GENERATED, (event) => {
  console.log('Code generated:', event.code);
});

client.on(EventType.FINAL_ANSWER, (event) => {
  console.log('Final answer:', event.content);
});

// Send a query
client.sendQuery('Search for the latest developments in quantum computing');
```

### 3. Use REST API (Non-streaming)

```bash
# Submit a query
curl -X POST http://localhost:8000/api/v2/agent/query \
  -H "Content-Type: application/json" \
  -d '{
    "query": "What is the capital of France?",
    "agent_type": "codact",
    "stream": false
  }'

# Get session info
curl http://localhost:8000/api/v2/session/{session_id}

# Get session events
curl http://localhost:8000/api/v2/session/{session_id}/events
```

## Event Types

The API emits various event types during agent execution:

### Agent Reasoning Events
- `agent_thought` - Agent's reasoning and analysis
- `agent_planning` - Planning steps (ReAct agents)

### Code Events
- `code_generated` - Python code generated by agent
- `code_execution_start` - Code execution begins
- `code_execution_output` - Output from code execution
- `code_execution_complete` - Code execution finished
- `code_execution_error` - Code execution error

### Tool Events
- `tool_call_start` - Tool invocation begins
- `tool_call_output` - Tool output/results
- `tool_call_complete` - Tool call finished
- `tool_call_error` - Tool call error

### Task Events
- `task_start` - Task processing begins
- `task_complete` - Task processing finished
- `final_answer` - Final answer to the query

### Metadata Events
- `stream_delta` - Streaming content updates
- `token_update` - Token usage updates
- `step_summary` - Summary of each step

## WebSocket Protocol

### Client → Server Messages

```typescript
// Submit a query
{
  "type": "query",
  "query": "Your question here"
}

// Request historical events
{
  "type": "get_events",
  "event_type": "code_generated",  // optional filter
  "limit": 50
}

// Get session state
{
  "type": "get_state"
}

// Keepalive ping
{
  "type": "ping"
}
```

### Server → Client Messages

The server sends event objects as they occur:

```typescript
{
  "event_id": "evt_123",
  "event_type": "agent_thought",
  "timestamp": "2024-01-20T10:30:00Z",
  "step_number": 1,
  "content": "Let me search for information about...",
  "complete": true
}
```

## REST Endpoints

### `POST /api/v2/agent/query`
Submit a query for processing.

**Request:**
```json
{
  "query": "Your question",
  "agent_type": "codact",
  "max_steps": 25,
  "stream": true
}
```

### `GET /api/v2/session/{session_id}`
Get session information.

### `GET /api/v2/session/{session_id}/events`
Get historical events with optional filtering.

**Query parameters:**
- `event_type` - Filter by event type
- `step_number` - Filter by step number
- `limit` - Maximum events to return

### `DELETE /api/v2/session/{session_id}`
Delete a session and clean up resources.

### `GET /api/v2/sessions`
List all active sessions.

### `GET /api/v2/health`
Health check endpoint.

## Frontend Integration

### React Example

See the complete example in `src/api/v2/examples/react-integration.tsx`.

Key concepts:
1. Connect to WebSocket on component mount
2. Register event handlers for different event types
3. Update UI state based on events
4. Clean up connection on unmount

### State Management

The example demonstrates managing:
- Chat messages (user queries and agent responses)
- Current execution step details
- Code execution and outputs
- Tool call status
- Token usage

## Session Management

Sessions provide isolation between different conversations:

- Each session has a unique ID
- Sessions maintain their own agent instance
- Events are scoped to sessions
- Sessions expire after 1 hour of inactivity
- Maximum 10,000 events per session (FIFO)

## Error Handling

The API provides detailed error information:

```typescript
// WebSocket error
{
  "type": "error",
  "message": "Detailed error message"
}

// Event-level errors
{
  "event_type": "code_execution_error",
  "error_type": "SyntaxError",
  "error_message": "invalid syntax",
  "traceback": "..."
}
```

## Performance Considerations

1. **Streaming vs Batch**: Use streaming for real-time UI updates, batch for simpler integrations
2. **Event Filtering**: Use event type filters to reduce data transfer
3. **Connection Management**: Implement reconnection logic for resilient clients
4. **Session Cleanup**: Sessions are automatically cleaned up after expiry

## Development Tips

1. **TypeScript**: Use the provided type definitions for type safety
2. **Event Ordering**: Events are emitted in execution order
3. **Error Recovery**: Handle both connection and execution errors
4. **Testing**: Use the REST API for easier testing and debugging

## Compatibility

The Web API v2 is designed to coexist with:
- Existing CLI functionality
- FastAPI v1 endpoints
- MCP server integration

It does not interfere with or modify existing agent behavior.