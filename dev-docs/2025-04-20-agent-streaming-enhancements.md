# DeepSearchAgents 开发日志 (2025-04-20)

## 概述

此次更新主要解决了 DeepSearchAgents 在流式输出模式下的若干问题，并增强了代理的状态管理、规划能力和多语言支持。主要修改包括修复 CodeAct 代理流式输出的错误处理、添加统一的配置加载机制、以及增强 ReAct 和 CodeAct 代理的状态管理和周期性规划能力。

## 修改详情

### 1. 配置管理 (`config_loader.py` - 新增)

- 实现了统一的配置加载机制，从 YAML 文件和环境变量中获取配置
- 添加了安全访问嵌套配置值的功能
- 提供 API 密钥管理功能
- 确保配置仅加载一次，提高性能
- 增加了配置验证和默认值设置

### 2. CodeAct 代理改进 (`codact_agent.py`)

- 修复了 `StreamingLiteLLMModel.__call__` 方法中 `stream` 参数重复传递的问题
- 添加 `_convert_stream_to_iterator` 方法，确保将 `CustomStreamWrapper` 对象转换为标准 Python 迭代器
- 实现了更健壮的 `StreamingFinalAnswerWrapper` 类，处理各种流式输出场景
- 添加了结构化状态管理（`visited_urls`, `search_queries`, `key_findings` 等）
- 增加了周期性规划支持（每 5 步重新评估搜索策略）
- 添加了 JSON grammar 支持，用于结构化输出
- 改进错误处理和日志记录

### 3. ReAct 代理改进 (`agent.py`)

- 增加了与 CodeAct 一致的状态管理
- 实现了周期性规划功能（每 7 步重新评估搜索策略）
- 添加初始化状态变量的功能
- 优化了工具初始化和配置
- 改进了流式输出支持

### 4. 命令行界面改进 (`cli.py`)

- 增强了流式输出的显示，实时展示思考和生成过程
- 改进了 JSON 结构化输出的显示（表格、折叠/展开）
- 增加了状态跟踪和统计显示（已访问 URL 数量、搜索查询数量等）
- 添加了任务执行统计（令牌生成速率、规划步骤次数等）
- 增强错误处理和用户反馈
- 支持单询问和交互式模式

### 5. 提示模板改进 (`prompts.py`)

- 增强了 `CODE_ACTION_SYSTEM_PROMPT`，添加结构化状态管理指导
- 添加了周期性规划指导（每 x 步重新评估策略）
- 添加了结构化 JSON 输出支持（标题、内容、来源、置信度）
- 增强了搜索策略指导
- 添加了多语言支持（英文搜索，用户语言输出）

### 6. API 服务改进 (`main.py`)

- 支持不同代理模式（ReAct vs CodeAct）
- 改进配置加载和错误处理
- 增强 API 端点文档
- 添加详细的健康检查端点
- 改进错误处理和日志记录

## 主要功能增强

1. **流式输出处理**：修复了 CustomStreamWrapper 对象处理问题，确保流式输出正常工作
2. **状态管理**：添加了统一的状态变量，跟踪已访问 URL、搜索查询等信息
3. **周期性规划**：为 ReAct 和 CodeAct 代理添加了周期性规划能力
4. **结构化输出**：支持 JSON 格式的结构化输出，包括标题、内容、来源和置信度
5. **配置管理**：提供统一、灵活的配置管理机制，支持 YAML 和环境变量
6. **多语言支持**：支持以英文进行搜索，以用户原始语言输出最终答案

## 已知问题与待办事项

1. 仍存在一些 linter 警告（主要是行长度问题），但不影响功能
2. 部分代码需要进一步优化，减少重复逻辑
3. 考虑添加单元测试，特别是针对流式输出和状态管理功能
4. 文档需要更新以反映新的配置选项和功能

## 下一步计划

1. 完善文档，特别是配置选项和新增功能
2. 解决剩余的 linter 警告
3. 增加测试覆盖率
4. 考虑添加更多工具和代理能力
5. 优化性能，特别是长文本处理和内存使用 